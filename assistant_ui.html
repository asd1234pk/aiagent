<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ«ƒå° AI é†«ç™‚è«®è©¢åŠ©ç†</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <header>
        <div class="logo">
            <!-- <img src="images/logo_placeholder.png" alt="é†«é™¢ Logo"> -->
            <h1>æ«ƒå° AI é†«ç™‚è«®è©¢åŠ©ç†</h1>
        </div>
        <nav>
            <a href="index.html">è¿”å›å…¥å£</a>
        </nav>
    </header>

    <div class="container">
        <div class="main-content">
            <h2>å³æ™‚è«®è©¢</h2>
            <div class="chat-container">
                <div class="chat-messages" id="chatMessages">
                    <!-- Messages will appear here -->
                    <div class="message ai-message">
                        <p>æ‚¨å¥½ï¼æˆ‘æ˜¯æ‚¨çš„ AI é†«ç™‚è«®è©¢åŠ©ç†ï¼Œè«‹å•æœ‰ä»€éº¼å¯ä»¥å”åŠ©æ‚¨çš„å—ï¼Ÿ</p>
                    </div>
                    <!-- Removed mock user and AI messages -->
                </div>
                <div id="thinking" style="display: none; text-align: center; padding: 10px;">æ­£åœ¨æ€è€ƒä¸­...</div>
                <form id="chat-form"> <!-- Added form element -->
                    <div class="chat-input">
                        <textarea id="userInput" placeholder="è«‹åœ¨æ­¤è¼¸å…¥æ‚¨çš„å•é¡Œ..." rows="1"></textarea>
                        <button type="submit" class="button" id="sendMessage">å‚³é€</button> <!-- Changed to type submit -->
                    </div>
                </form>
            </div>
        </div>
    </div>

    <footer>
        <p class="footer-text">&copy; 2024 æ‚¨çš„é†«é™¢åç¨±. All Rights Reserved.</p>
    </footer>

    <script>
        const textarea = document.getElementById('userInput'); // Still needed for auto-resize
        textarea.addEventListener('input', () => {
            textarea.style.height = 'auto'; // Reset height
            textarea.style.height = textarea.scrollHeight + 'px'; // Set to content height
        });

        // Corrected IDs and form handling
        const chatHistory = document.getElementById('chatMessages'); // Corrected ID
        const chatForm = document.getElementById('chat-form');       // Corrected: now points to the form
        const messageInput = document.getElementById('userInput');   // Corrected ID
        const thinkingIndicator = document.getElementById('thinking');

        chatForm.addEventListener('submit', async function(event) {
            event.preventDefault();
            const userMessage = messageInput.value.trim();

            if (!userMessage) {
                return;
            }

            appendMessage('user', userMessage);
            messageInput.value = '';
            textarea.style.height = 'auto'; // Reset textarea height after sending
            messageInput.disabled = true;
            if(thinkingIndicator) thinkingIndicator.style.display = 'block';

            try {
                const response = await fetch('/api/ask', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ question: userMessage }),
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    let errorMessage = `API éŒ¯èª¤: ${response.status}`;
                    if (errorData && errorData.detail) {
                        errorMessage += ` - ${errorData.detail}`;
                    }
                    appendMessage('assistant', errorMessage, [], true);
                    return;
                }

                const data = await response.json();
                appendMessage('assistant', data.answer, data.sources);

            } catch (error) {
                console.error('å‘¼å« API æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                appendMessage('assistant', 'æŠ±æ­‰ï¼Œç„¡æ³•é€£æ¥åˆ°åŠ©ç†æœå‹™ã€‚è«‹ç¨å¾Œå†è©¦ã€‚', [], true);
            } finally {
                messageInput.disabled = false;
                if(thinkingIndicator) thinkingIndicator.style.display = 'none';
                messageInput.focus();
            }
        });

        function appendMessage(sender, text, sources = [], isError = false) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message', `${sender}-message`);
            if (isError) {
                messageDiv.classList.add('error-message');
            }

            const contentP = document.createElement('p');
            contentP.innerHTML = text.replace(/\n/g, '<br>');
            messageDiv.appendChild(contentP);

            if (sources && sources.length > 0) {
                const sourcesTitle = document.createElement('h5');
                sourcesTitle.textContent = 'åƒè€ƒä¾†æº:';
                messageDiv.appendChild(sourcesTitle);

                const sourcesList = document.createElement('ul');
                sourcesList.classList.add('sources-list');
                sources.forEach(source => {
                    const listItem = document.createElement('li');
                    const link = document.createElement('a');
                    link.href = source.url;
                    link.textContent = `${source.title} (ç›¸ä¼¼åº¦: ${source.score.toFixed(4)})`;
                    link.target = '_blank';
                    listItem.appendChild(link);
                    sourcesList.appendChild(listItem);
                });
                messageDiv.appendChild(sourcesList);
            }
            
            if (sender === 'assistant' && !isError) {
                const feedbackDiv = document.createElement('div');
                feedbackDiv.classList.add('feedback-buttons');
                
                let lastUserQuestionText = 'N/A';
                const messages = chatHistory.getElementsByClassName('message');
                if (messages.length > 1) {
                    for (let i = messages.length - 2; i >= 0; i--) {
                        if (messages[i].classList.contains('user-message')) {
                            const userPara = messages[i].querySelector('p');
                            if (userPara) {
                                lastUserQuestionText = userPara.textContent || userPara.innerText;
                            }
                            break;
                        }
                    }
                }

                const goodButton = document.createElement('button');
                goodButton.textContent = 'ğŸ‘ å¥½è©•';
                goodButton.onclick = () => submitFeedbackToServer(lastUserQuestionText, text, 'good');
                feedbackDiv.appendChild(goodButton);
                
                const badButton = document.createElement('button');
                badButton.textContent = 'ğŸ‘ å¾…æ”¹é€²';
                badButton.onclick = () => submitFeedbackToServer(lastUserQuestionText, text, 'bad');
                feedbackDiv.appendChild(badButton);
                
                const detailButton = document.createElement('button');
                detailButton.textContent = 'ğŸ“ è©³ç´°å›é¥‹';
                detailButton.onclick = () => openDetailedFeedback(lastUserQuestionText, text);
                feedbackDiv.appendChild(detailButton);
                
                messageDiv.appendChild(feedbackDiv);
            }

            chatHistory.appendChild(messageDiv);
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }

        async function submitFeedbackToServer(question, answer, feedbackType, details = null) {
            console.log(`æäº¤å›é¥‹: å•é¡Œ="${question}", å›ç­”="${answer}", é¡å‹=${feedbackType}, ç´°ç¯€=${details}`);
            try {
                const response = await fetch('/api/feedback', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        question: question,
                        answer: answer,
                        feedback_type: feedbackType,
                        details: details
                    }),
                });
                const result = await response.json();
                if (response.ok) {
                    alert(`æ„Ÿè¬æ‚¨çš„å›é¥‹ (ID: ${result.feedback_id})ï¼`);
                } else {
                    alert(`æäº¤å›é¥‹å¤±æ•—: ${result.detail || 'æœªçŸ¥éŒ¯èª¤'}`);
                }
            } catch (error) {
                console.error('æäº¤å›é¥‹ API éŒ¯èª¤:', error);
                alert('æäº¤å›é¥‹æ™‚ç™¼ç”Ÿé€£æ¥éŒ¯èª¤ã€‚');
            }
        }

        function openDetailedFeedback(question, answer) {
            localStorage.setItem('questionForFeedback', question);
            localStorage.setItem('answerForFeedback', answer);
            window.location.href = 'detailed_feedback_ui.html';
        }

    </script>
</body>
</html> 